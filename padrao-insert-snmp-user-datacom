#!/usr/bin/env python3

import paramiko
import telnetlib
import time
import sys
from datetime import datetime

ARQUIVO_IPS = "DMOS-todos-ips.txt"

LOG_OK = "login_ok.log"
LOG_FAIL = "login_fail.log"
LOG_CFG = "config_aplicada.log"

CREDENCIAIS = [
    ("admin", "admin"),
    ("dmview", "dmview@toledo"),
    ("jean", "portugal@1985"),
    ("jean", "Portugal@1985"),
]

COMANDOS_CONFIG = [
    "config",
    "aaa user jean",
    "password $1$X6UBuL99$RyvbVzGt5ALO7Msionn3x1",
    "group admin",
    "no snmp community public",
    "snmp agent enabled",
    "snmp agent version v2c",
    "snmp community zabbix@toledo",
    "sec-name datacom",
    "snmp vacm group zabbix@toledo",
    "member zabbix@toledo",
    "sec-model v2c",
    "access \"\" v2c no-auth-no-priv",
    "read-view root",
    "write-view root",
    "snmp vacm view root",
    "subtree 1.3",
    "included",
    "commit"
]

# ---------- UTIL ----------
def log(arquivo, msg):
    with open(arquivo, "a") as f:
        f.write(f"{datetime.now()} - {msg}\n")

def ler_ips(nome_arquivo):
    try:
        with open(nome_arquivo, "r") as f:
            return [linha.strip() for linha in f if linha.strip()]
    except FileNotFoundError:
        print(f"‚ùå Arquivo {nome_arquivo} n√£o encontrado")
        sys.exit(1)

# ---------- SSH ----------
def conectar_ssh(ip, user, password):
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        ssh.connect(
            hostname=ip,
            username=user,
            password=password,
            timeout=6,
            allow_agent=False,
            look_for_keys=False
        )
        return ssh
    except Exception:
        return None

def aplicar_config_ssh(ssh, ip):
    shell = ssh.invoke_shell()
    time.sleep(1)

    for cmd in COMANDOS_CONFIG:
        shell.send(cmd + "\n")
        time.sleep(1)

    log(LOG_CFG, f"{ip} - CONFIG APLICADA")
    print(f"üõ†Ô∏è  CONFIG APLICADA - {ip}")

# ---------- TELNET ----------
def testar_telnet(ip, user, password):
    try:
        tn = telnetlib.Telnet(ip, timeout=5)
        tn.read_until(b"Username:", timeout=3)
        tn.write(user.encode() + b"\n")
        tn.read_until(b"Password:", timeout=3)
        tn.write(password.encode() + b"\n")
        time.sleep(2)
        saida = tn.read_very_eager().decode(errors="ignore")
        tn.close()

        if "invalid" in saida.lower() or "failed" in saida.lower():
            return False
        return True
    except Exception:
        return False

# ---------- MAIN ----------
ips = ler_ips(ARQUIVO_IPS)

for ip in ips:
    print(f"\nüîç Testando IP: {ip}")
    autenticado = False

    for user, password in CREDENCIAIS:
        ssh = conectar_ssh(ip, user, password)
        if ssh:
            print(f"‚úÖ LOGIN OK - {ip} - SSH - {user}")
            log(LOG_OK, f"{ip} - SSH - {user}")
            aplicar_config_ssh(ssh, ip)
            ssh.close()
            autenticado = True
            break

        if testar_telnet(ip, user, password):
            print(f"‚ö†Ô∏è LOGIN OK - {ip} - TELNET - {user} (sem config)")
            log(LOG_OK, f"{ip} - TELNET - {user}")
            autenticado = True
            break

    if not autenticado:
        print(f"‚ùå LOGIN FAIL - {ip}")
        log(LOG_FAIL, ip)
